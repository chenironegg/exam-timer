<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>考試倒數計時器</title>
    <style>
        /* CSS美編部分，採用蘋果系統風格 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: #fff;
            width: 100%;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        main {
            flex: 1;
            width: 90%;
            max-width: 800px;
            padding: 20px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        form {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .exam-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .exam-entry input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex: 1;
            min-width: 120px;
        }

        button {
            padding: 10px 20px;
            background-color: #007aff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        button:hover {
            background-color: #0051a8;
        }

        .hidden {
            display: none;
        }

        .timer {
            text-align: center;
        }

        .current-time {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .exam-info {
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .countdown {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .controls button {
            padding: 10px 20px;
            background-color: #ff3b30;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .controls button:hover {
            background-color: #c1271b;
        }

        .results {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .results ul {
            list-style: none;
            padding: 0;
        }

        .results li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #34c759;
            color: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header>
        <h1>考試倒數計時器</h1>
    </header>
    <main>
        <form id="exam-form">
            <div id="exam-entries">
                <div class="exam-entry">
                    <input type="text" class="subject" placeholder="考試科目" required>
                    <input type="time" class="start-time" required>
                    <input type="time" class="end-time" required>
                </div>
            </div>
            <button type="button" id="add-exam">新增考試科目</button>
            <button type="submit">開始計時</button>
        </form>

        <div id="clock" class="timer hidden">
            <div class="current-time" id="current-time">00:00:00</div>
            <div class="exam-info" id="exam-info">科目: 無 | 時間: 00:00</div>
            <div class="countdown" id="countdown">00:00:00</div>
            <div class="controls">
                <button id="stop-button" class="hidden">停止作答</button>
            </div>
        </div>

        <div id="results" class="results hidden">
            <h2>今天考試結果</h2>
            <ul id="results-list"></ul>
        </div>
    </main>

    <div id="notification" class="notification"></div>

    <script>
        // JavaScript部分
        document.addEventListener('DOMContentLoaded', () => {
            const examForm = document.getElementById('exam-form');
            const addExamButton = document.getElementById('add-exam');
            const examEntries = document.getElementById('exam-entries');
            const clock = document.getElementById('clock');
            const currentTimeDisplay = document.getElementById('current-time');
            const examInfoDisplay = document.getElementById('exam-info');
            const countdownDisplay = document.getElementById('countdown');
            const stopButton = document.getElementById('stop-button');
            const results = document.getElementById('results');
            const resultsList = document.getElementById('results-list');
            const notification = document.getElementById('notification');

            let exams = [];
            let currentExamIndex = 0;
            let timerInterval = null;
            let countdownInterval = null;
            let countdownEndTime = null;
            let countdownType = null; // 'exam' or 'rest'
            let startTime = null;
            let actualEndTime = null;
            let restTime = 0;
            let stopRequested = false;
            let examResults = [];

            // 添加新的考試輸入欄位
            addExamButton.addEventListener('click', () => {
                const entry = document.createElement('div');
                entry.classList.add('exam-entry');
                entry.innerHTML = `
                    <input type="text" class="subject" placeholder="考試科目" required>
                    <input type="time" class="start-time" required>
                    <input type="time" class="end-time" required>
                    <button type="button" class="remove-exam">移除</button>
                `;
                examEntries.appendChild(entry);
            });

            // 移除考試輸入欄位
            examEntries.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-exam')) {
                    e.target.parentElement.remove();
                }
            });

            // 顯示通知
            function showNotification(message) {
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // 處理表單提交
            examForm.addEventListener('submit', (e) => {
                e.preventDefault();
                // 收集考試資料
                const subjects = document.querySelectorAll('.subject');
                const startTimes = document.querySelectorAll('.start-time');
                const endTimes = document.querySelectorAll('.end-time');

                exams = [];
                for (let i = 0; i < subjects.length; i++) {
                    const subject = subjects[i].value.trim();
                    const start = startTimes[i].value;
                    const end = endTimes[i].value;
                    if (subject && start && end) {
                        exams.push({
                            subject,
                            startTime: convertTimeToDate(start),
                            endTime: convertTimeToDate(end),
                            plannedDuration: getDuration(start, end),
                            actualDuration: null
                        });
                    }
                }

                // 排序考試時間
                exams.sort((a, b) => a.startTime - b.startTime);

                // 隱藏表單，顯示時鐘
                examForm.classList.add('hidden');
                clock.classList.remove('hidden');

                // 開始計時
                startTimer();
            });

            // 將時間轉換為Date對象
            function convertTimeToDate(timeStr) {
                const now = new Date();
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
                return date;
            }

            // 計算持續時間（分鐘）
            function getDuration(start, end) {
                const diff = (end - start) / 1000; // 秒
                return diff;
            }

            // 更新當前時間
            function updateCurrentTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
                currentTimeDisplay.textContent = timeStr;
            }

            // 開始計時器
            function startTimer() {
                updateCurrentTime();
                timerInterval = setInterval(updateCurrentTime, 1000);
                checkExamStart();
            }

            // 檢查並處理考試開始
            function checkExamStart() {
                if (currentExamIndex >= exams.length) {
                    endAllExams();
                    return;
                }

                const exam = exams[currentExamIndex];
                const now = new Date();

                if (now >= exam.startTime && now < exam.endTime) {
                    // 考試已經開始
                    const elapsed = (now - exam.startTime) / 1000; // 秒
                    const remaining = exam.plannedDuration - elapsed;
                    startExam(remaining > 0 ? remaining : 0, elapsed > exam.plannedDuration ? elapsed - exam.plannedDuration : 0);
                } else if (now < exam.startTime) {
                    // 尚未開始，等待考試開始
                    const delay = exam.startTime - now;
                    setTimeout(() => {
                        showNotification(`${exam.subject} 考試開始`);
                        startExam(exam.plannedDuration, 0);
                    }, delay);
                } else {
                    // 已經過了考試時間，跳過
                    currentExamIndex++;
                    checkExamStart();
                }
            }

            // 開始一場考試
            function startExam(plannedDuration, overtime) {
                countdownType = 'exam';
                const now = new Date();
                startTime = new Date(now - (overtime * 1000));
                countdownEndTime = new Date(startTime.getTime() + (plannedDuration * 1000));
                examInfoDisplay.textContent = `科目: ${exams[currentExamIndex].subject} | 時間: ${formatDuration(plannedDuration)}`;
                updateCountdown();

                // 顯示停止按鈕
                stopButton.classList.remove('hidden');

                // 顯示考試開始通知
                showNotification(`${exams[currentExamIndex].subject} 考試開始`);

                countdownInterval = setInterval(updateCountdown, 1000);
            }

            // 更新倒數計時
            function updateCountdown() {
                const now = new Date();
                let remaining;

                if (countdownType === 'exam') {
                    remaining = Math.floor((countdownEndTime - now) / 1000);
                    if (remaining >= 0) {
                        countdownDisplay.textContent = formatTime(remaining);
                    } else {
                        // 超時處理
                        countdownDisplay.textContent = formatTime(-remaining);
                        // 切換到超時倒數
                        countdownType = 'overtime';
                        countdownEndTime = now;
                    }
                } else if (countdownType === 'overtime') {
                    const overtimeSeconds = Math.floor((now - countdownEndTime) / 1000);
                    countdownDisplay.textContent = formatOvertime(overtimeSeconds);
                }

                // 檢查是否需要自動跳到下一場考試
                if (currentExamIndex < exams.length - 1) {
                    const nextExam = exams[currentExamIndex + 1];
                    if (now >= nextExam.startTime) {
                        // 自動跳過休息時間，開始下一場考試
                        clearInterval(countdownInterval);
                        finalizeExam(Math.floor((countdownEndTime - startTime) / 1000));
                        currentExamIndex++;
                        checkExamStart();
                    }
                } else {
                    // 最後一場考試後不需要自動開始下一場
                }
            }

            // 格式化時間為 HH:MM:SS
            function formatTime(seconds) {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            }

            // 格式化超時時間為 SS:SS:SS
            function formatOvertime(seconds) {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            }

            // 格式化持續時間為 MM:SS
            function formatDuration(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${pad(mins)}:${pad(secs)}`;
            }

            // 補零
            function pad(num) {
                return num.toString().padStart(2, '0');
            }

            // 停止作答
            stopButton.addEventListener('click', () => {
                clearInterval(countdownInterval);
                finalizeExam(Math.floor((new Date() - startTime) / 1000));
                stopRequested = true;
                stopButton.classList.add('hidden');
                currentExamIndex++;
                checkExamStart();
            });

            // 完成一場考試的處理
            function finalizeExam(actualDuration) {
                const exam = exams[currentExamIndex];
                exam.actualDuration = actualDuration;
                examResults.push({
                    subject: exam.subject,
                    planned: formatDuration(exam.plannedDuration),
                    actual: formatDuration(actualDuration)
                });
                showNotification(`${exam.subject} 考試結束`);
            }

            // 結束所有考試
            function endAllExams() {
                clearInterval(timerInterval);
                clearInterval(countdownInterval);
                clock.classList.add('hidden');
                displayResults();
            }

            // 顯示結果
            function displayResults() {
                resultsList.innerHTML = '';
                examResults.forEach((result, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. 科目: ${result.subject} | 預定時間: ${result.planned} | 實際時間: ${result.actual}`;
                    resultsList.appendChild(li);
                });
                if (examResults.length === exams.length) {
                    const li = document.createElement('li');
                    li.textContent = '恭喜你完成所有考試！';
                    resultsList.appendChild(li);
                }
                results.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
